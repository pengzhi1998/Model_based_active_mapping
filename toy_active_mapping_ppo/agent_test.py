import argparse
import os
import numpy as np

from stable_baselines3 import PPO
from env import SimpleQuadrotor

ACTION = np.array([[4, 3, 0], [0, -2, 0],
    [-4, -5, 0], [-2, -1, 0], [-1, 4, 0], [0, 4, 0]])/5

parser = argparse.ArgumentParser(description='landmark-based mapping')
parser.add_argument('--num-landmarks', type=int, default=5)
parser.add_argument('--horizon', type=int, default=15)
parser.add_argument('--bound', type=int, default=10)
parser.add_argument('--learning-curve-path', default="tensorboard/ppo_toy_active_mapping/")
parser.add_argument('--model-path', default="checkpoints/ppo_toy_active_mapping/default")
parser.add_argument('--model', default="attention")
parser.add_argument('--seed', type=int, default=0, help="use multiple seeds to train, values should be 0, 10, and 100")
parser.add_argument('--count', type=int, default=0, help="just for large-scale comparison, to decide input which initialized landmarks")
parser.add_argument('--SE3-control', type=int, default=1, help="if true: use SE3 control to directly control v_x and v_yaw while v_y is always 0,"
                                                           "if false: directly control x and y while yaw is always kept 0")
parser.add_argument('--motion-model', type=int, default=1, help="if 1: noisy static model (landmarks moving in smaller area),"
                                                           "if 2: noisy motion model (landmarks moving in one direction with noise)")
parser.add_argument('--for-comparison', type=int, default=0, help="0 means this code is running for training or simple tests,"
                                                                  "otherwise this is for large-scale tests, while we need to read the"
                                                                  "randomized landmarks' and agent's initial positions from a generated"
                                                                  "txt file for fair comparison with landmark-based iCR")
parser.add_argument('--special-case', type=int, default=0, help="0 means all the initial information values are the same, 0.5,"
                                                                "otherwise there would be one with a special value, like 100")
parser.add_argument('--dynamics-noise', type=int, default=0, help="0 means there would be dynamics noise during testing, "
                                                                  "otherwise there is no noise for both testing and training")
args = parser.parse_args()


data_file_path = os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                "plots/landmarks_agent_init_pos.txt")
results_file_path = os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                "plots/testing_results.txt")
num_landmarks = [3, 5, 8]
horizon = [8, 15, 18]
bound = [8, 10, 12]
seed = ['0', '10', '100']
model = ['attention', 'mlp']
np.random.seed(100)
def generate_testing_data():
    if not os.path.exists(data_file_path):
        my_open = open(data_file_path, "a")
        element_store = []
        for i in range(len(num_landmarks)):
            elements = []
            for num_tests in range(30):
                lx = np.random.uniform(low=-bound[i], high=bound[i], size=(num_landmarks[i], 1))
                ly = np.random.uniform(low=-bound[i], high=bound[i], size=(num_landmarks[i], 1))
                landmarks = np.concatenate((lx, ly), 1).reshape(num_landmarks[i]*2, 1).tolist()
                agent_pos = np.array([np.random.uniform(-2, 2), np.random.uniform(-2, 2), 0]).tolist()
                elements.append([landmarks, agent_pos])
                element_store.append([landmarks, agent_pos])
            my_open.write(str(elements))
            my_open.write("\n")
        my_open.close()
        print("Successfully generate the test data for randomized landmarks and robot positions", element_store)
    else:
        element_store = [[[[0.781016062837196], [0.7181309279503498], [3.4430298619587116], [-1.2215232105775247], [1.644214017146302], [2.334305809066498]], [-0.24965115494922996, 1.567092003128319, 0.0]], [[[7.4186041680164685], [0.4623187160464717], [-1.8649356987875567], [1.088712977502917], [4.667600609322633], [6.8095462126825765]], [-1.7158557672084522, -1.6514828011938372, 0.0]], [[[-7.6765056409547885], [5.920194371949107], [5.321917528767008], [7.657893475724224], [4.450508015197608], [4.786537027467578]], [-0.15408255098827262, 1.1221167051458218, 0.0]], [[[-6.1076091860970685], [7.114702672793342], [2.238736341240381], [0.3495731480011468], [-5.7063474014552575], [-1.3654089601516226]], [-0.9417775515814921, 1.0969347577368667, 0.0]], [[[-0.7015946845352232], [1.882167953214033], [1.0949431818983761], [1.7935315635587425], [-7.699363193018318], [1.8709439499961107]], [1.7749923140584967, 0.7272811964139336, 0.0]], [[[-2.247873590819424], [-7.036392453931683], [-1.0074887392105367], [2.668267447130683], [3.1620991348362377], [2.7302059138905506]], [-1.1584697557046364, -1.4842948093805868, 0.0]], [[[-2.953146385213058], [-0.9823757846028744], [-2.1806276649180383], [7.813981408947619], [1.1231483266860742], [-6.367283028031551]], [-1.1644929756206612, -1.354761928460015, 0.0]], [[[2.449733207446375], [-4.089190527974356], [-3.947334359363486], [-5.4564866616716845], [-0.5390276342990994], [-6.233997741371118]], [0.6253183578610937, -1.4472681946055448, 0.0]], [[[-4.854682213119144], [-6.44637958731102], [-2.1003972694245743], [5.4071185199808625], [5.135891677566962], [-6.462425473696591]], [1.905837860053583, -0.1253951934091937, 0.0]], [[[7.628177411045394], [-7.372995323930869], [1.6775283159207355], [-3.4750885987774467], [3.8282172703728268], [-6.0768550205892975]], [-0.8154392099114203, -1.5250891241830238, 0.0]], [[[-2.9122691296963836], [3.0795539099203175], [-1.3717920877652805], [1.0656232673052024], [-6.97364005841945], [-3.7537681449688733]], [0.09299221386679868, -1.6242379569662333, 0.0]], [[[1.2151439288988684], [2.678566079418907], [6.868739161219425], [-5.891234201529725], [-2.9028967607788214], [3.4612352658970487]], [-0.8423756282111956, -1.2672345519715327, 0.0]], [[[1.3842069569613304], [-7.924872380919247], [-7.678279261000103], [2.8450645887396817], [5.2630404674778095], [-3.6798724289253624]], [0.9407760884903795, 1.848754180469753, 0.0]], [[[-4.0199497036806715], [1.156030492653974], [1.2185173506853904], [-4.430693877750107], [1.4726709003494243], [7.24398418427176]], [-0.21149848552949058, 1.3856346898845113, 0.0]], [[[3.191668405080069], [-1.6559081464482457], [-3.2410087863178614], [6.097651153778585], [5.0207651152396355], [1.3003659621737391]], [1.5269414474194112, 0.7701263603110635, 0.0]], [[[3.6040684771142484], [2.3038431876741985], [0.021190110827236097], [-1.218319223069125], [7.297338155571582], [1.7022914260467896]], [-1.923227206762666, -0.7937007333018027, 0.0]], [[[2.5627765998829606], [-1.1397007848677418], [-3.358758284632895], [-5.832414972440796], [1.8882468639814647], [-3.2274827847035077]], [0.2798596428050595, 0.3634910449926929, 0.0]], [[[1.189203981593261], [-1.0973050330564167], [2.451213117714138], [6.344745533617008], [2.433652320027022], [-2.1190100792336555]], [-0.25654029893749275, 1.5676934200626884, 0.0]], [[[4.899103824737372], [6.711721819914777], [3.262217336645861], [3.4278607927857827], [-6.396369803003182], [7.981552105085864]], [-1.402206781368025, 1.472504229472857, 0.0]], [[[-5.400113045178003], [5.5681316691557505], [1.8489530285415068], [4.917103339600171], [-6.018880274408936], [1.105611817833493]], [-0.37126681109600135, -1.7233320181794478, 0.0]], [[[3.1588603703130183], [5.862117214858067], [-0.7433170771508983], [7.608344080046173], [3.5528895915255667], [5.692853478281776]], [-1.9531436632599921, -0.5600877420865444, 0.0]], [[[3.6798489987849283], [-7.130592186571942], [-5.253925163816952], [-4.800055601657599], [0.3365856992660685], [-7.7036512886301765]], [1.1747908134296825, -1.1043012477584795, 0.0]], [[[-2.474373108849557], [-7.4905771274990745], [6.849300695449454], [-5.364893496033396], [3.2706304307765244], [1.9436544239962164]], [0.30891435441667037, -1.0484287145019655, 0.0]], [[[6.9474239667967], [1.4385596216731358], [1.8234552954543357], [3.681952472268314], [0.5701248483993329], [-3.0088800723263702]], [-0.4071157511356325, -1.1606250040995114, 0.0]], [[[-5.020911905914621], [-0.15265906211892677], [7.109958239742937], [-4.361365952426828], [3.832812720788601], [-3.930296291673713]], [-1.7678833587044975, -0.2623334977675169, 0.0]], [[[-3.011265888094359], [-5.126341159045843], [3.141495821047352], [-7.6051403457387], [-1.9559705713203055], [-6.924005896588023]], [0.7175710939942692, -0.18521262177581876, 0.0]], [[[0.5852673777395552], [-4.529648249624417], [6.346740688645474], [2.6092512496016127], [7.84542315834727], [-3.7868419722055897]], [-1.9173960021370853, 1.0335146153445658, 0.0]], [[[-2.8797255868405145], [5.296775283779047], [-1.8645776932496325], [2.0637094974583796], [1.4130738168576915], [5.962410487158325]], [-0.9058318607374569, 1.1921873356502548, 0.0]], [[[-5.029824891104765], [-4.551877166183065], [7.244666511551113], [7.157929447822788], [2.9998124222050446], [3.693692908322525]], [-0.9842334296198967, -1.146752090530072, 0.0]], [[[0.29121142289061197], [-1.2050324999759], [-7.589396511127495], [-2.013280314652391], [-4.6804787929422496], [-0.5827932101630289]], [-0.8894851748210724, 0.34713738583267517, 0.0]], [[[7.277112118464629], [-2.0788059438541246], [-7.649362880759338], [1.3084262371701794], [0.34758214308228297], [-6.334403275718428], [-7.358637873096933], [-7.103044813132455], [4.337193623851874], [-0.23887438702090869]], [-0.5775490486001775, 1.7617277810112522, 0.0]], [[[5.306505076139306], [1.6895213791153765], [4.9732723970109465], [9.23872757094458], [8.074394794918668], [-4.157049464149023], [-8.331551291159629], [-5.183424401691063], [1.0438493984481312], [-7.994121154690044]], [-1.9342814816341032, 1.7181172671687621, 0.0]], [[[3.398330931818201], [-0.2874480813075415], [5.703058240462756], [9.549902794888936], [-4.365397884921018], [7.530104906331815], [1.7282033237265342], [-3.236820963263087], [-8.720894677580377], [9.231403090829971]], [-1.073193494115182, 1.7972752896627258, 0.0]], [[[8.827554094129972], [6.978871106258364], [5.984051747047834], [2.357533838350477], [2.608958737335822], [-9.73526284482201], [7.48575933249894], [-3.055329641355609], [-4.139594309844066], [-7.0371827810367]], [1.9273175592730127, -0.08651877184004775, 0.0]], [[[-0.05217269002674563], [-6.20304176194484], [2.789450327974471], [0.22637965092912005], [-2.62830787740765], [-5.513659420505215], [-7.261994566288021], [-8.043110310119319], [6.44235466388491], [7.243830348433665]], [1.8916779560925212, 1.8433386322520007, 0.0]], [[[8.131109984423578], [-5.355317156581146], [5.480946653972776], [-7.350247304840341], [-3.3370969594271616], [-8.931456364263495], [-8.377972200240064], [4.511887284211575], [-1.8551765717238524], [-9.771450827499379]], [1.082322994011105, -1.4122134183984998, 0.0]], [[[-8.409558348264884], [1.1473758264783385], [-8.207939315227893], [7.211023476575875], [3.440956147078289], [4.540885254226566], [-5.092655802943105], [-4.593441895225707], [-1.5892106663980314], [-7.370344014177448]], [-1.7785027183152082, -0.7936054620762301, 0.0]], [[[-4.757637015206435], [-2.40146088199759], [-0.8771886639904061], [-6.376980765261939], [3.6656267109536085], [5.770910246130374], [3.9125089127771435], [-8.863038471335194], [-4.329623068356668], [3.9399448344997463]], [1.1147815837644135, 1.1096302473950126, 0.0]], [[[-4.811548713092901], [-6.058914396287207], [-2.523737241348771], [-0.8028823248798531], [1.7519927039277796], [-9.107753974917719], [-4.543561951510659], [5.995917691412361], [-2.5829440156422256], [-8.460871060267346]], [0.07534059532610415, -0.7727596018192155, 0.0]], [[[1.5508589766275094], [0.2003370463650036], [9.188666816668501], [0.7235498940690395], [2.911404889120078], [3.6278502120767584], [-9.292751284890182], [-4.448078045364678], [-1.3919512098387763], [-7.422788690673596]], [-0.4292972938116226, 1.8256228911837953, 0.0]], [[[-6.257382164983105], [-0.8279207646282831], [8.079679098564739], [4.483352732230866], [0.8761190015465274], [-2.0194935659379603], [-0.8617715670846842], [8.080887858019153], [7.640828204597792], [3.8005004038245467]], [0.7984882170020668, -0.6891183937715244, 0.0]], [[[5.135572854737784], [9.183332060704451], [2.721221108942826], [-0.837223454799144], [-5.1995945324058095], [1.8196833064736992], [-6.789223550294872], [7.154452883871091], [5.927829490346635], [-0.8555309329228589]], [1.8074979073309447, 0.3030046481794897, 0.0]], [[[6.4153424140262985], [-2.031314827606458], [8.176874368254769], [-8.745740959533086], [6.310476375371376], [-1.5193549622031615], [-6.811710731020881], [-4.826318662211846], [2.5779687812340075], [6.9807661685702165]], [-1.8667814938132152, 1.8359308874538942, 0.0]], [[[-2.892623030561408], [8.585828346054278], [-2.8658621919491427], [-8.007701395574573], [-9.673429946325843], [8.90603066958159], [-6.295353495276322], [7.3897706109326435], [-1.974809983927825], [-0.916752061848964]], [-0.6931964729269597, -1.0690234828837726, 0.0]], [[[2.2892941295374865], [-4.961180235078142], [-9.338508170489888], [-5.576781693078323], [-9.687878711063435], [-4.9361761255429615], [-1.4240855500352438], [-7.378895375694845], [-8.638518520505595], [-9.759275542046915]], [-1.5380628114450077, 0.4739210380509915, 0.0]], [[[9.485124256361004], [-0.1938930690252576], [9.806900031217879], [9.78819554568863], [-1.8189180925387678], [-8.693915856964395], [-6.740911479067893], [5.664688766276262], [2.7752351473305854], [-4.232030053370122]], [-1.034325519693704, 0.6500182861307038, 0.0]], [[[-5.078736300180711], [-4.258969601607405], [3.317182351183753], [4.131494125459579], [0.34617034404577574], [-1.702862613328719], [-1.5182202312830135], [-2.789088790282155], [1.09375617322838], [6.573138291114756]], [1.6998676478127686, -1.8159707564508123, 0.0]], [[[-5.34746014340469], [8.098966910998538], [-3.0296126101487353], [-4.068874698719402], [6.299329587404948], [9.840224868289482], [9.70982855286595], [-5.011599178870975], [9.379434093407035], [-7.881876902355356]], [1.8038104442215763, -1.0663189781276148, 0.0]], [[[3.795365301555009], [-2.418862078451429], [-8.832872820388227], [-2.514076333581679], [4.614181982549523], [4.975765150802662], [7.6344042466767945], [-5.243855149219224], [-4.5512620906807495], [-6.56293801904714]], [-0.2028334052490477, -0.782126370490722, 0.0]], [[[6.783782445173049], [7.345788109249295], [-5.245163479687225], [8.804193787095347], [0.04778914978522941], [5.015297237727038], [8.851671993958607], [3.9915012044950267], [2.6799539548932145], [9.359311332084541]], [1.9776031585907177, -0.19271326932096144, 0.0]], [[[-8.582604436315833], [2.0823560804176395], [-4.144119371189623], [-2.3438388168429185], [-6.952905886245391], [7.907717685764201], [-1.650272504079764], [9.355893435970039], [-7.37421343053488], [0.9376980333884433]], [-0.9007057205296136, 0.3689216750473472, 0.0]], [[[7.935223164488196], [-1.965729292408028], [-1.8653330832850337], [-5.03173069834058], [1.0415655338394174], [0.11732767650616793], [-4.566944647877083], [-3.792383480403771], [-0.8911170109994604], [-2.5393027223850506]], [0.09988176901705703, 1.00238009171595, 0.0]], [[[-3.3298506841744935], [-1.0772897468159606], [8.483175332415271], [-7.907442225150518], [7.246370936718048], [-3.030480219330059], [-9.026194080489429], [4.801950512353649], [-4.927149514863545], [3.6102896228565164]], [0.4895377142640194, 0.8421136108893825, 0.0]], [[[-5.901526260805965], [-4.346006981089268], [-3.166037702705358], [-9.395294839880348], [3.5248496455492564], [4.206736579484268], [7.5846952606265425], [-9.842317929831193], [0.873561076561904], [-2.54641860358009]], [0.1221488582511272, 1.6884458470687722, 0.0]], [[[-8.210109099341999], [-4.418641035428033], [-1.881153560634326], [-5.805001006887299], [-9.513736005796844], [-7.6859353334581275], [-3.1477803131681936], [1.5428048804068357], [2.4446211767958985], [3.90540011809372]], [0.6878285623832894, 1.7954440828820295, 0.0]], [[[-9.945935722129946], [-9.662566532599206], [2.94393307788072], [3.929648614029002], [2.007844741952791], [6.27357299403727], [1.7747921994057627], [0.19614393243168315], [9.255406396804847], [-3.320702608063817]], [1.1633606529096197, -1.6110282974703014, 0.0]], [[[-1.1592872454014937], [-1.7939687461974874], [0.39904749141676454], [2.4658934604026133], [3.8791282186909513], [7.7392156243483505], [-8.18228535935181], [2.3765233648275306], [-5.444809969242781], [-7.330770581301311]], [1.9223205311491296, 1.4871429390219717, 0.0]], [[[0.054415222906481375], [9.365728205885947], [8.44695963593266], [8.395656215563168], [0.8276158751427154], [-9.27932365142861], [8.466121357783262], [-6.504559916781201], [6.597947372066862], [-2.217306457976285]], [1.8085707891816831, -0.7998843220962817, 0.0]], [[[-6.790647122247979], [3.2223502301619895], [7.726093321731199], [-1.1947249434101632], [-1.072111690335941], [-8.470264619394293], [8.157511887086521], [3.929262893050012], [-6.795390673597135], [-5.052024889216926]], [-1.841537909681929, -1.760222807001707, 0.0]], [[[-8.778429258664254], [0.5787985806176632], [8.154659149700791], [-3.9110727130524348], [4.79767835658202], [9.95924502657347], [7.961247144274701], [-2.7562188212122134], [3.4516462259304266], [-0.5870210157218096]], [-0.4870193003061529, 1.9181077173418344, 0.0]], [[[-7.808198750519861], [0.34830583917016256], [-4.128287978206088], [-3.169738067111009], [4.328367984360035], [-1.0435226096962715], [-10.483017159872865], [-3.900542837658243], [2.573984976276984], [11.291848646303464], [-0.5364839309660141], [-8.797453638105504], [-5.184000557709574], [-9.67670512371902], [-6.278081257822608], [-3.7585985090180145]], [0.364107603481965, 0.636705887400113, 0.0]], [[[-2.465838067966992], [6.349487384585004], [11.982671854132107], [4.757963467638973], [-3.5545680913669777], [-3.948043927778409], [5.313760031038861], [-8.455546123039024], [3.3019846687390277], [-10.496735926564565], [7.513292717939056], [-6.194359099164364], [11.429415922891678], [-1.6252444516488325], [9.355047754692965], [0.5279105671195801]], [1.0923342162194865, 1.834963692226372, 0.0]], [[[-9.184308470764535], [-2.871955595338246], [-9.431900635349002], [-8.452591759265463], [2.152673352325218], [4.438426528405426], [5.889553774735031], [3.7622870025800896], [8.355609128327636], [8.689502300428973], [10.459969925202927], [-9.665808125096625], [11.60222981425541], [-0.053354212191797146], [-2.404759386611378], [1.9459663121295137]], [-1.0337718398403264, -1.3238983754833549, 0.0]], [[[8.629940074070916], [-9.184426459603348], [-10.59516186634659], [-5.489950157715261], [-0.705098305966251], [-2.308974223983972], [-9.219983968778752], [-2.4045086397760613], [-1.0305897280471825], [4.113203488083677], [11.519095832215424], [-3.726764942987817], [-1.8310475170686527], [5.130404841840392], [8.570998020109617], [3.340485581409421]], [-0.40335541898090765, -0.27295948938272296, 0.0]], [[[2.7486647954476986], [-2.2710340116346543], [-10.318987436528529], [-4.294968238962794], [7.737761720536568], [-11.281192202286014], [3.6821078667272857], [5.6941018223154565], [5.4322191460280465], [-9.365173006499983], [0.8861520259773705], [2.551395193082044], [-9.348549336198126], [4.877219915213178], [-2.279145280873202], [3.234871750408674]], [1.8365690079119, -1.5868073796594455, 0.0]], [[[8.81201181852478], [0.43559553098818427], [-11.299434363626082], [8.226644704436215], [0.8380045182500151], [-3.0428170621249393], [-2.2981531694577892], [-6.6512683676404745], [0.5804126494501958], [-10.067231916675741], [-3.237602950559765], [-9.95253784515112], [-7.426394041438367], [-6.686485288973467], [-11.541050461231446], [-9.599662537882676]], [-0.9398412065420718, -1.7354021515321811, 0.0]], [[[-10.425483186961785], [-1.6083790492516634], [8.550628310946767], [0.6776181402848582], [-8.109113742988002], [-3.613432990835163], [1.4323777397627513], [6.755510405631874], [6.562933066776733], [6.024519572553562], [-1.0461704318624], [10.25308337695483], [-8.319146931375702], [-11.305138823352948], [-7.209692589117256], [9.496590989044883]], [-0.42972484615139583, 1.5134899815199763, 0.0]], [[[4.578834627756709], [-0.09671291103672885], [11.696370169775236], [4.361758681664668], [6.222778841200032], [-5.343833488674155], [-3.2509289760771214], [0.5851154658532796], [0.025516148034050445], [-9.182872939906627], [-2.9666602753355704], [-8.163713115499409], [-3.242115935490286], [-10.87664748690747], [-5.738292014854566], [11.297554626495188]], [-1.9845585939589556, -1.2856801277693748, 0.0]], [[[2.708802074807817], [10.339649215151354], [-10.047129627520672], [0.4982744938046526], [9.165516074323975], [-5.5870312353043525], [5.270883788214917], [9.05757094017887], [11.193359314509443], [-3.0739500357009284], [0.18325313377835784], [-11.966799600024022], [-4.790311604196307], [-6.055559460184417], [1.188013747086515], [-4.362395779750503]], [1.4351098729276086, -0.16598733173421998, 0.0]], [[[-1.329905092528783], [4.216539543462403], [-3.933545606402703], [-6.122652493917614], [9.13627495312991], [-6.805025737338965], [10.680642646569392], [-8.014852211490105], [11.805367899711104], [10.146158645408768], [-2.958209592936317], [-4.942160102804014], [11.187538695052112], [-1.1257381092269174], [7.005109671141632], [-0.14501198430663642]], [1.1126863818010166, 1.3769398462120965, 0.0]], [[[-8.662255172433293], [-1.8080879318257708], [-1.7542953549342322], [-9.417175076410034], [8.228517308050971], [1.6372222480762808], [7.632799338140124], [-6.082633444532253], [-9.542069797142005], [2.314393568390944], [-8.246799627168887], [-9.179384570312696], [-4.699231401614212], [11.421212842044802], [-10.191382341999832], [10.38146889257617]], [-0.4328122457413368, -1.0312856234956582, 0.0]], [[[-5.990442891514253], [10.904011569424608], [-0.3985551551425921], [-3.5535302281034227], [-11.040172754382793], [9.541026351585732], [3.3529225458030467], [6.479212470002132], [-2.2007301998461237], [-3.421808361726887], [-2.9422422578667042], [2.9199704748781876], [7.424759315740761], [-5.074321016359306], [5.016851044398962], [8.985598009796217]], [-1.550290731150755, -1.1502625548238359, 0.0]], [[[-7.607200990081893], [-7.001921949084388], [-2.3273759422970723], [10.377454535051864], [5.8855910407711], [-6.830443095762283], [0.6457787772523282], [8.6001033272223], [-0.29576823508301864], [7.269440917472021], [-11.986896842472104], [-8.180490313386173], [-1.790358591478686], [2.537086974486691], [-10.474709403932199], [-9.22411507427968]], [0.9115526334780459, 0.5498491094888265, 0.0]], [[[7.486525480584461], [-9.426942109714895], [-0.4947708146594856], [7.616138675078915], [9.95671410800119], [-0.6445685168245383], [-10.815625277077448], [9.17480812605858], [-4.970674439351648], [5.598939223601427], [5.161262339164008], [-2.166571064862154], [-1.9653789180479784], [-3.035735660263592], [-7.849167497492247], [0.37532031963004187]], [1.5562398127589145, 0.9491143188566715, 0.0]], [[[-11.876328857543442], [10.490809006572427], [4.659788432859013], [10.159327381409], [10.068177765739698], [-5.2119155477740104], [5.050938228107796], [-3.84885494001122], [-7.751861242380098], [2.4051088351510543], [-0.3955649417409912], [11.116735086249122], [-8.632415569837935], [-8.452767982430629], [-3.3841133198488293], [-5.834000551519941]], [1.4942273091630858, -0.03243107316662197, 0.0]], [[[9.57506621344876], [9.959298487574845], [-7.54757045944377], [5.561860450389425], [0.7840460993126577], [5.461127791956713], [-4.169528816415063], [-5.04207720979307], [-4.402978562580575], [1.8650261836041686], [-1.2749528652912208], [6.700306399244017], [-1.6061412215695583], [7.094168845037114], [-3.423674887729094], [-3.7312689418965057]], [1.0834910262745914, 0.9435755872309319, 0.0]], [[[-8.603844345074393], [8.802925038218294], [8.782691245595455], [3.0656341486868257], [-1.408284715670142], [-2.3657292166675212], [-0.3261492266720296], [-1.9993978341909369], [-1.2391397064480643], [7.460126763094834], [1.6283040354601805], [-3.6433933740835176], [2.908061936809313], [-6.925084901222075], [-0.04369042168935877], [-10.574803487861058]], [1.5041073916822967, 1.6741858047613998, 0.0]], [[[-9.117115628076576], [8.72329558064606], [-3.9726302040932424], [1.596146567739904], [-7.791070331634147], [-3.16998029237104], [-9.218436748178886], [-3.783782960996211], [9.596801832000725], [6.1767394377050095], [-10.634945780511469], [-4.450240919897107], [11.531655923256164], [3.7756539988114035], [-9.68517934326278], [0.41582600438592365]], [-0.06013741936771799, 1.6046486825966464, 0.0]], [[[1.3114814068862302], [-4.00627117261635], [7.844678473168678], [-9.606409266365905], [5.4137648184357445], [-0.5858611899637509], [-11.07462609458404], [7.680538460874043], [6.554641260130062], [-4.843503368086462], [-6.795113997815024], [-8.377562464535002], [9.675591524437717], [-4.073591143274419], [-10.969819425388032], [7.533123406095264]], [-1.4384641688026125, -1.0905502036899928, 0.0]], [[[-10.347552852159026], [-6.776091757014277], [4.9370410557505835], [11.3716487243036], [-2.5144021551279163], [-8.103409250095996], [-4.539840548560416], [-5.019818240238179], [5.2470333681876475], [-7.684913019995001], [-3.9365389838338736], [-3.707864247447972], [5.466510557146034], [-0.4785386923018642], [7.564785487543524], [0.5322208560508592]], [1.414424169185088, 1.5577916352634662, 0.0]], [[[-6.717507341258247], [-10.339616188982653], [2.94945677245806], [9.100160104497707], [-9.324094624830826], [5.635530591133467], [-0.9847233556303614], [-7.764014666662557], [-4.263995086881165], [10.539861818096888], [-4.403982109113446], [0.15149337656132644], [-0.41797819890957655], [11.995405874807169], [5.51586325270242], [-7.2657726167822965]], [0.13963279353280544, -0.8390078297602863, 0.0]], [[[-4.6998346226580825], [8.971972280033235], [2.1855691400157653], [8.015559453039163], [10.121257604899998], [-6.867951676761923], [7.3263325339001995], [6.509411111181844], [5.374593564031819], [-11.70789223336179], [1.420170770440853], [-4.2520910988458995], [10.135164088018744], [-6.490381327393205], [-0.1833262394187809], [0.1647110036955226]], [0.9474126467231421, -1.6092945302091035, 0.0]], [[[0.3581328464824409], [-10.944589631421826], [10.521888520665257], [9.108515592569525], [-6.512482776409308], [0.4819539992561541], [4.251387458674181], [-11.26413484018277], [2.2291264987477817], [-6.614073313899835], [-11.75847130425376], [10.888216714255513], [-0.5801712994266541], [1.9756735932493275], [5.010489382585167], [-9.42065837354869]], [-0.849821990877754, -0.17318549655806326, 0.0]], [[[-11.497198337574469], [3.3509338311297974], [-2.1212276732697894], [10.764967227092185], [-0.2529927495672446], [6.678628015114651], [-6.151730993250427], [8.360286474960144], [2.1273360070076777], [-0.22992219752939747], [6.0777628702122435], [-7.551633912494812], [-6.339978621464748], [11.89956703103124], [2.8919976067197055], [-8.895461735071208]], [-0.11417072258293848, -1.7276276030315736, 0.0]], [[[10.652420576419669], [-8.59638538316454], [11.158198580362551], [-4.398464002717049], [5.265337488095366], [3.0409554230185165], [-3.600171752875946], [5.4610466301779965], [-5.894822373177016], [-11.41745508907053], [-5.632720211110862], [-1.6772163749582418], [-8.944943389918206], [3.6509902762113366], [0.6194148738413503], [8.477903427804307]], [-0.09870087115167037, 1.876823486870741, 0.0]], [[[-5.6248188590052655], [5.16343804860864], [-11.675791040958746], [1.3932296797743007], [-0.38993124715833183], [4.91875348614623], [-5.853268919519569], [-1.9527152743193632], [7.769224128556065], [-11.872558857247974], [-6.41345586765331], [-11.727476915707378], [-4.544898761008649], [0.2693229017684793], [6.989458344458697], [-10.001016486744017]], [-1.7956980793229729, 1.8620665565498933, 0.0]], [[[8.616063351793407], [-5.648409647932793], [-8.351346546970332], [11.402272325089115], [-11.984058753835093], [3.3471065873762456], [10.600027089354153], [0.4962669955812853], [-5.320192840317256], [-2.4499532439614953], [-7.53845753146806], [6.588022917220847], [4.596194587956845], [-8.61702056343135], [-9.38631026780817], [11.216107248887571]], [1.4444920322631467, 0.47062793027697314, 0.0]], [[[-10.970251430338603], [-9.593958142179634], [4.820535586745706], [6.215629314056208], [9.91882418125154], [-11.59054832978166], [0.5898496194870226], [11.209318033853268], [-3.4986042761456932], [2.7613924952423083], [-9.113343720492729], [1.2585374157991964], [6.11762649930164], [-4.897203993865733], [9.24052442908335], [10.303000117674802]], [-0.9363774906528359, 1.3125864528667797, 0.0]], [[[11.64260830409117], [-3.41381078207187], [6.8015194923553395], [-8.071577732360437], [0.45575808927436157], [-1.4070205600203316], [-10.414217667559875], [-5.692801048212263], [-0.6620690598942467], [0.5294980963743452], [-1.4818572726791146], [-11.156158566811339], [-7.132895011512114], [9.74955407489482], [-1.8338967188566926], [7.5927433324765445]], [0.21032533004201825, 1.4072343310289726, 0.0]], [[[11.097481771459211], [-11.95044874621388], [-9.347464942736146], [-7.226127967995369], [3.139963401835292], [10.946955829439041], [11.951856022455807], [-4.069426257531747], [11.709340064004628], [3.321362538646765], [2.4797518149778703], [-5.259372128826175], [-8.927499109180399], [10.747725290678147], [1.9966279437726762], [5.485409518787684]], [-0.6813953696743495, 1.1670456847214834, 0.0]]]
    return element_store



def test_agent(agent):
    # get env
    NUM_TEST = 10
    my_open_results = open(results_file_path, "a")
    env = SimpleQuadrotor(args.bound, args.num_landmarks, args.horizon, args.SE3_control, args.motion_model,
                          args.for_comparison, args.special_case, True)
    init_agent_landmarks = generate_testing_data()

    # get parameters
    try:
        gamma = float(agent.gamma)
    except:
        gamma = 1.
    print(f"gamma = {gamma}")

    # test
    reward_list = []
    for eps in range(NUM_TEST):
        if args.for_comparison == True:
            obs = env.reset(init_agent_landmarks[args.count*10+eps])
        else:
            obs = env.reset()
        done = False
        total_reward = 0

        # print(f"\n------ Eps {eps} ------")
        # print(f"init state = {obs}")

        t = 0
        env.save_plot(name=os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                        "plots/test_landmarknum{}_eps{}_step{}_model_{}_seed{}.png".format(
                                            args.num_landmarks, eps, t, args.model, args.seed)),
                      title=f'return = {0}')
        while not done:
            if t == 0 or t == int(args.horizon/3 - 1) or t == int(args.horizon*2/3 - 1):
                total_reward_ = format(total_reward, '.2f')
                if args.for_comparison == False:
                    if t == 0:
                        env.save_plot(name=os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                                    "plots/test_landmarknum{}_eps{}_step{}.png".format(args.num_landmarks, eps, t)), title=f'return = {total_reward}', legend=True)
                    else:
                        env.save_plot(name=os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                                    "plots/test_landmarknum{}_eps{}_step{}.png".format(args.num_landmarks, eps, t)), title=f'return = {total_reward_}')

            # get action
            action, _state = agent.predict(obs, deterministic=True)
            # action = ACTION[t]
            t += 1

            # step env
            obs, r, done, info = env.step(action)

            # calc return
            total_reward += r

            # render
            if args.for_comparison == False:
                env.render(mode='human')
                env.save_plot(name=os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                                "plots/test_landmarknum{}_eps{}_step{}_model_{}_seed{}.png".format(
                                                    args.num_landmarks, eps, t, args.model, args.seed)),
                              title=f'return = {0}')

        # summary
        print("---")
        print(f"count: {args.count*10+eps}, return = {total_reward}")
        if args.for_comparison == True:
            if (args.count*10+eps) % 30 == 0:
                data = ["model_" + args.model + "_num_landmarks_" + str(args.num_landmarks) + "\n" + str(np.round(total_reward, 3)) + " " + str(np.round(info, 3)) + "\n"]
            else:
                data = [str(np.round(total_reward, 3)) + " " + str(np.round(info, 3)) + "\n"]
            for element in data:
                my_open_results.write(element)
        reward_list.append(total_reward)
        total_reward_ = format(total_reward, '.2f')
        if args.for_comparison == False:
            env.save_plot(name=os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                             "plots/test_landmarknum{}_eps{}_step{}_model_{}_seed{}.png".format(args.num_landmarks, eps, t, args.model, args.seed)), title=f'return = {total_reward_}')
    env.close()
    print(f"mean and std of total return = {np.mean(reward_list), np.std(reward_list)}")
    my_open_results.close()

if __name__ == '__main__':
    # load model
    model = PPO.load(os.path.join(os.path.abspath(os.path.dirname(__file__)),
                                  "checkpoints/ppo_toy_active_mapping/default/landmark_{}-seed_{}-model_{}/best_model.zip".format(args.num_landmarks, args.seed, args.model)))

    # test
    test_agent(model)


